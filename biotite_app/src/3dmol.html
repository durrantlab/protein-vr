<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">

        <title>3DMolController</title>
        <meta name="description" content="3DMolController">
        <meta name="author" content="DurrantLab">

        <!--[if lt IE 9]>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
            <![endif]-->
    </head>

    <body>
        <div id="mol-container" class="mol-container" style="width:150px; height:150px;"></div>

        <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>

        <script src="https://3Dmol.csb.pitt.edu/build/3Dmol.js"></script>
        <script>
            let element = jQuery("#mol-container");
            let config = { backgroundColor: "white" };
            let viewer = $3Dmol.createViewer( element, config );
            window.vrmlStr = "";
            let pdbTxt = "";
            let hasActiveSurface = false;

            // Listen for a message from the parent.
            // https://robertnyman.com/html5/postMessage/postMessage.html
            if (window.addEventListener) {  // For standards-compliant web browsers
                window.addEventListener("message", getMsgFromParent, false);
            } else {
                window.attachEvent("onmessage", getMsgFromParent);
            }

            function getMsgFromParent(evt) {
                let data = evt["data"];
                console.log("IFRAME: Msg from main:");
                console.log(data);

                let val = data[1];
                switch (data[0]) {
                    case "addPDBTxt":
                        addPDBTxt(val);
                        break;
                    case "setStyle":
                        setStyle(val["sels"], val["rep"]);
                        break;
                    case "exportVRML":
                        exportVRML();
                        break;
                    case "addSurface":
                        addSurface(val["colorScheme"], val["sels"]);
                        break;
                    case "removeAllSurfaces":
                        removeAllSurfaces();
                        break;
                    default:
                }
            }

            function sendMsgToParent(msg) {
                console.log("IFRAME: Msg to main:");
                console.log(msg);
                window.top.postMessage(msg, window.origin);
            }

            function addPDBTxt(data) {
                pdbTxt = data;  // In case you need to restart.
                viewer.addModel( data, "pdb" );
                viewer.zoomTo();
                sendMsgToParent("addPDBTxtDone");
            }

            function setStyle(sels, rep) {
                viewer.setStyle(sels, rep);
                viewer.render();
            }

            function addSurface(colorScheme, sels) {
                hasActiveSurface = true;
                viewer.addSurface(
                    $3Dmol.SurfaceType.MS,
                    colorScheme,
                    sels,
                    undefined,
                    undefined,
                    () => {
                        sendMsgToParent("addSurfaceDone");
                    },
                );
            }

            function removeAllSurfaces() {
                viewer.removeAllSurfaces();
            }

            function resetAll() {
                if (hasActiveSurface) {
                    hasActiveSurface = false;

                    // I can't get rid of the surfaces without causing
                    // problems. I'm just going to go nuclear and reload the
                    // whole thing.
                    viewer = null;
                    viewer = $3Dmol.createViewer( element, config );
                    viewer.addModel( pdbTxt, "pdb" );
                }
                // debugger;
                // Removes surfaces and styles and reloads pdb txt.
                // viewer.removeAllSurfaces();
                // viewer.clear();
                // viewer.render();

                // viewer.addModel( pdbTxt, "pdb" );
                // viewer.zoomTo();

                viewer.setStyle({}, {});
                // viewer.removeAllSurfaces();
            }

            function exportVRML() {
                vrmlStr = viewer.exportVRML();
                sendMsgToParent("exportVRMLDone");
            }

            // Let the parent function know when everything is loaded.
            $(document).ready(function() {
                sendMsgToParent("3DMolLoaded");
            });
        </script>
    </body>
</html>
